---
name: "Redfish Password Policy and Security Test"
description: "Comprehensive test suite for Redfish password policy enforcement and security validation on OpenBMC systems"

stages:
  - name: "Initial Setup and Connectivity"
    steps:
      - cmd: "cmd"
        name: "Test BMC Connectivity"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "[[attributes.RedfishUrl]]/redfish/v1/"]
          expect:
            - regex: "200$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Verify Account Service Accessibility"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc", "[[attributes.RedfishUrl]]/redfish/v1/AccountService/"]
          expect:
            - regex: "200$"
        options:
          timeout: "30s"

  - name: "Password Policy Enforcement Tests"
    steps:
      - cmd: "cmd"
        name: "Test Weak Password Rejection - Too Short"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc",
                "-X", "POST",
                "-H", "Content-Type: application/json",
                "-d", "{\"UserName\": \"weakuser1\", \"Password\": \"123\", \"RoleId\": \"ReadOnly\", \"Enabled\": true}",
                "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/"]
          expect:
            - regex: "400$|422$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Test Weak Password Rejection - Less than 8 Characters"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc",
                "-X", "POST",
                "-H", "Content-Type: application/json",
                "-d", "{\"UserName\": \"weakuser2\", \"Password\": \"Pass12\", \"RoleId\": \"ReadOnly\", \"Enabled\": true}",
                "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/"]
          expect:
            - regex: "400$|422$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Test Empty Password Rejection"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc",
                "-X", "POST",
                "-H", "Content-Type: application/json",
                "-d", "{\"UserName\": \"emptyuser\", \"Password\": \"\", \"RoleId\": \"ReadOnly\", \"Enabled\": true}",
                "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/"]
          expect:
            - regex: "400$|422$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Test Missing Password Field Rejection"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc",
                "-X", "POST",
                "-H", "Content-Type: application/json",
                "-d", "{\"UserName\": \"nopassuser\", \"RoleId\": \"ReadOnly\", \"Enabled\": true}",
                "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/"]
          expect:
            - regex: "400$|422$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Test Valid Password Acceptance"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc",
                "-X", "POST",
                "-H", "Content-Type: application/json",
                "-d", "{\"UserName\": \"validuser\", \"Password\": \"ValidPass123\", \"RoleId\": \"ReadOnly\", \"Enabled\": true}",
                "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/"]
          expect:
            - regex: "201$"
        options:
          timeout: "30s"

  - name: "Password Change Operations Tests"
    steps:
      - cmd: "cmd"
        name: "Verify Initial Authentication with Original Password"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "validuser:ValidPass123", "[[attributes.RedfishUrl]]/redfish/v1/AccountService/"]
          expect:
            - regex: "200$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Change Password to New Valid Password"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc",
                "-X", "PATCH",
                "-H", "Content-Type: application/json",
                "-d", "{\"Password\": \"NewValidPass456\"}",
                "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/validuser/"]
          expect:
            - regex: "200$|204$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Test Authentication with New Password"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "validuser:NewValidPass456", "[[attributes.RedfishUrl]]/redfish/v1/AccountService/"]
          expect:
            - regex: "200$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Test Old Password No Longer Works"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "validuser:ValidPass123", "[[attributes.RedfishUrl]]/redfish/v1/AccountService/"]
          expect:
            - regex: "401$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Test Password Change with Invalid Weak Password"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc",
                "-X", "PATCH",
                "-H", "Content-Type: application/json",
                "-d", "{\"Password\": \"weak\"}",
                "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/validuser/"]
          expect:
            - regex: "400$|422$"
        options:
          timeout: "30s"

  - name: "Security Scenarios Tests"
    steps:
      - cmd: "cmd"
        name: "Test Duplicate Username Rejection"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc",
                "-X", "POST",
                "-H", "Content-Type: application/json",
                "-d", "{\"UserName\": \"validuser\", \"Password\": \"AnotherPass789\", \"RoleId\": \"Operator\", \"Enabled\": true}",
                "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/"]
          expect:
            - regex: "400$|409$|422$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Test Reserved Username Rejection - root"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc",
                "-X", "POST",
                "-H", "Content-Type: application/json",
                "-d", "{\"UserName\": \"root\", \"Password\": \"SecurePass123\", \"RoleId\": \"Administrator\", \"Enabled\": true}",
                "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/"]
          expect:
            - regex: "400$|409$|422$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Test Invalid User Modification - Non-existent User"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc",
                "-X", "PATCH",
                "-H", "Content-Type: application/json",
                "-d", "{\"Password\": \"NewSecurePass123\"}",
                "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/nonexistentuser/"]
          expect:
            - regex: "404$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Test Password Change for Non-existent User"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc",
                "-X", "PATCH",
                "-H", "Content-Type: application/json",
                "-d", "{\"Password\": \"SomeNewPass789\"}",
                "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/fakeusernotfound/"]
          expect:
            - regex: "404$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Create User for Disable Test"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc",
                "-X", "POST",
                "-H", "Content-Type: application/json",
                "-d", "{\"UserName\": \"testdisable\", \"Password\": \"DisableTestPass123\", \"RoleId\": \"ReadOnly\", \"Enabled\": true}",
                "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/"]
          expect:
            - regex: "201$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Verify User Can Authenticate Before Disabling"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "testdisable:DisableTestPass123", "[[attributes.RedfishUrl]]/redfish/v1/AccountService/"]
          expect:
            - regex: "200$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Disable User Account"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc",
                "-X", "PATCH",
                "-H", "Content-Type: application/json",
                "-d", "{\"Enabled\": false}",
                "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/testdisable/"]
          expect:
            - regex: "200$|204$"
        options:
          timeout: "30s"

  - name: "Authentication Validation Tests"
    steps:
      - cmd: "cmd"
        name: "Test Authentication with Correct Credentials"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "validuser:NewValidPass456", "[[attributes.RedfishUrl]]/redfish/v1/AccountService/"]
          expect:
            - regex: "200$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Test Authentication Failure with Wrong Password"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "validuser:WrongPassword123", "[[attributes.RedfishUrl]]/redfish/v1/AccountService/"]
          expect:
            - regex: "401$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Test Authentication Failure with Wrong Username"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "wronguser:NewValidPass456", "[[attributes.RedfishUrl]]/redfish/v1/AccountService/"]
          expect:
            - regex: "401$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Test Authentication with Disabled Account"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "testdisable:DisableTestPass123", "[[attributes.RedfishUrl]]/redfish/v1/AccountService/"]
          expect:
            - regex: "401$|403$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Test Authentication with No Credentials"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "[[attributes.RedfishUrl]]/redfish/v1/AccountService/"]
          expect:
            - regex: "401$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Test Authentication with Malformed Credentials"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "malformed:credentials:with:colons", "[[attributes.RedfishUrl]]/redfish/v1/AccountService/"]
          expect:
            - regex: "401$"
        options:
          timeout: "30s"

  - name: "Advanced Security Tests"
    steps:
      - cmd: "cmd"
        name: "Test Valid Username Creation"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc",
                "-X", "POST",
                "-H", "Content-Type: application/json",
                "-d", "{\"UserName\": \"specialuser\", \"Password\": \"SpecialPass123\", \"RoleId\": \"ReadOnly\", \"Enabled\": true}",
                "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/"]
          expect:
            - regex: "201$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Test Standard Length Username Creation"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc",
                "-X", "POST",
                "-H", "Content-Type: application/json",
                "-d", "{\"UserName\": \"standarduser\", \"Password\": \"StandardPass123\", \"RoleId\": \"ReadOnly\", \"Enabled\": true}",
                "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/"]
          expect:
            - regex: "201$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Test Case Sensitivity in Username Authentication"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "ValidUser:NewValidPass456", "[[attributes.RedfishUrl]]/redfish/v1/AccountService/"]
          expect:
            - regex: "401$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Test Alphanumeric Username Creation"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc",
                "-X", "POST",
                "-H", "Content-Type: application/json",
                "-d", "{\"UserName\": \"alphanumuser\", \"Password\": \"AlphaNumPass123\", \"RoleId\": \"ReadOnly\", \"Enabled\": true}",
                "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/"]
          expect:
            - regex: "201$"
        options:
          timeout: "30s"

  - name: "Cleanup Test Users"
    steps:
      - cmd: "cmd"
        name: "Cleanup - Delete Valid Test User"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc", "-X", "DELETE", "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/validuser/"]
          expect:
            - regex: "200$|204$|404$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Cleanup - Delete Disabled Test User"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc", "-X", "DELETE", "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/testdisable/"]
          expect:
            - regex: "200$|204$|404$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Cleanup - Delete Special Test User"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc", "-X", "DELETE", "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/specialuser/"]
          expect:
            - regex: "200$|204$|404$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Cleanup - Delete Standard Test User"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc", "-X", "DELETE", "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/standarduser/"]
          expect:
            - regex: "200$|204$|404$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Cleanup - Delete Alphanumeric Test User"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc", "-X", "DELETE", "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/alphanumuser/"]
          expect:
            - regex: "200$|204$|404$"
        options:
          timeout: "30s"

      - cmd: "cmd"
        name: "Final Verification - Ensure Test Users Are Removed"
        transport:
          proto: "local"
        parameters:
          executable: "curl"
          args: ["-k", "-s", "-w", "%{http_code}", "-u", "root:0penBmc", "[[attributes.RedfishUrl]]/redfish/v1/AccountService/Accounts/validuser/"]
          expect:
            - regex: "404$"
        options:
          timeout: "30s"
